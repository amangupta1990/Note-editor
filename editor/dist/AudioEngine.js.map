{"version":3,"file":"AudioEngine.js","sourceRoot":"","sources":["../src/AudioEngine.ts"],"names":[],"mappings":"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","sourcesContent":["import { concat, flatten } from \"lodash\";\nimport {PolySynth , now  , Transport, Part, start as startAudio, TransportTime, Time, } from \"tone\";\nimport { Tone } from \"tone/build/esm/core/Tone\";\nimport {ed_note,\n        ed_selected_note,\n        ed_beam,\n        ed_selected,\n        ed_sheet,\n        ed_state,\n        ed_stave,\n        ed_tie\n        } from './models'\n\n\n        document.addEventListener(\"click\", async () => {\n                \n                await startAudio();\n                console.log(\"context started\");\n            });\n\n        const DURATION_VALUES =  (key:string)=>{\n                switch(key.toLocaleLowerCase()){ \n              case \"w\": return '1n';\n              case \"h\": return '2n';\n              case \"q\": return '4n';\n              case \"8\": return '8n';\n              case \"16\": return '16n';\n              case \"32\": return '32n';\n              default: return 0;\n                }\n              }\n\nconst synth = new PolySynth().toDestination();\n\nfunction getToneNotes(notes:ed_note[]){\n      \n        const tone_notes = (notes).map((_note:ed_note, i:number)=> {\n                const accidentals = _note.accidentals.map(acc=> acc?.replace(\"##\",\"x\"));\n                \n                return {\n                        notes: _note.keys.map((k,i)=> k.replace(\"/\",accidentals[i] || '') ),\n                        duration: DURATION_VALUES(_note.duration)\n                }\n          })\n          return tone_notes;\n        }\n\nexport function playChord(_notes:ed_note[]) {\n        return\n        const _now = now()\n        const notesToPlay = getToneNotes(_notes);\n        notesToPlay.map(n=>{\n                const { notes , duration } = n;\n                synth.triggerAttackRelease(notes, duration, _now)\n\n        })\n        \n    \n\n}\n\n// exact should be an exact replica of the sheet object in vexflow \n\n\ninterface au_track  {\n        \n}\n\nexport class  AudioEngine {\n        \n        private bpm: number;\n        private timeSig : number [];\n        private _numTracks:number = 0;\n        private _tracks:any = {}; \n        private notes: ed_note[];\n\n        constructor(sheet:ed_sheet, timeSig: string,  BPM : number ,){\n                this.bpm = BPM || 120 ;\n                this.notes = [];\n                this.timeSig = [ ... timeSig.split(\"/\")].map((sig=> parseInt(sig)));\n                Transport.bpm.value = this.bpm;\n                Transport.timeSignature = this.timeSig;\n                this.updateTrack(sheet);\n                Transport.on('stop',()=>{\n                        console.log('transportEnded')\n                })\n\n\n                \n        }\n\n        _add(){\n                this._tracks[this._numTracks] = []\n        }\n\n        _getTime(staveIndex: number, noteIndex: number , duration: string){\n                \n                \n                return `${staveIndex}:${noteIndex}:0`;\n                \n\n        }\n\n        updateTrack(sheet:ed_sheet){\n                Transport.stop();\n                Transport.cancel();\n                this.notes = [];\n                sheet.staves\n                .map((stave:ed_stave)=>stave.notes)\n                .map((_notes:ed_note[])=>  { this.notes = concat( this.notes ,_notes) } );\n                const _notes = this.notes;\n\n                \n                                  \n                const partNotes =   _notes.map((note: ed_note,i:number)=>{\n\n                        const {notes ,duration} = getToneNotes([note])[0];\n                 \n                \n                                const time = this._getTime(note.staveIndex, note.noteIndex, note.duration  )\n                                return { notes, time , duration , isRest : note.isRest};\n                                \n                       })\n                       \n\n                                             \n                                            \n                for (const pn of partNotes) {\n                        Transport.schedule((time) => {\n                                if(!pn.isRest)\n                                synth.triggerAttackRelease(pn.notes, pn.duration ,time);\n                        }, pn.time);\n                }                      \n       \n                Transport.start();\n                \n         }\n\n}"]}